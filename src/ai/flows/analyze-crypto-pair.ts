// This is an autogenerated file from Firebase Studio.
'use server';

/**
 * @fileOverview Analyzes a cryptocurrency pair using technical indicators and Gemini AI for trend predictions and recommendations.
 *
 * - analyzeCryptoPair - A function that initiates the cryptocurrency pair analysis.
 * - AnalyzeCryptoPairInput - The input type for the analyzeCryptoPair function.
 * - AnalyzeCryptoPairOutput - The return type for the analyzeCryptoPair function.
 */

import type { Genkit } from 'genkit';
import { AnalyzeCryptoPairInputSchema, type AnalyzeCryptoPairInput, AnalyzeCryptoPairOutputSchema, type AnalyzeCryptoPairOutput } from '@/lib/types';


export async function analyzeCryptoPair(input: AnalyzeCryptoPairInput, dynamicAi: Genkit): Promise<AnalyzeCryptoPairOutput> {

  const analyzeCryptoPairPrompt = dynamicAi.definePrompt({
    name: 'analyzeCryptoPairPrompt',
    input: {schema: AnalyzeCryptoPairInputSchema},
    output: {schema: AnalyzeCryptoPairOutputSchema},
    prompt: `Bạn là một nhà phân tích kỹ thuật và giao dịch tiền mã hóa chuyên nghiệp. Nhiệm vụ của bạn là đưa ra một phân tích toàn diện, chuyên sâu và có tính thực tiễn cao cho cặp {{{pair}}} trên khung thời gian {{{timeframe}}}, phù hợp với chế độ giao dịch '{{{mode}}}'.

**Dữ liệu đầu vào:**
- Giá hiện tại: {{{price}}}
- RSI (14): {{{rsi}}}
- MACD (12, 26, 9):
    - Đường MACD: {{{macd.line}}}
    - Đường tín hiệu: {{{macd.signal}}}
- EMA:
    - EMA 9: {{{ema.ema9}}}
    - EMA 21: {{{ema.ema21}}}
- Khối lượng giao dịch (Volume) nến gần nhất: {{{volume}}}
- **Tâm lý tin tức gần đây: {{{newsSentiment}}} (Positive/Negative/Neutral)**

---

**CÁC KHÁI NIỆM VÀ CHIẾN LƯỢC GIAO DỊCH CẦN ÁP DỤNG:**

*   **1. Chiến lược Giao dịch Mua theo Sóng Điều Chỉnh (Pullback Entry):**
    *   **Mô tả:** Tìm kiếm cơ hội mua trong một xu hướng tăng đang diễn ra. Thay vì mua ở đỉnh, chờ đợi một đợt giá "điều chỉnh" (pullback) về một vùng hỗ trợ động quan trọng.
    *   **Cách xác định:**
        1.  **Xu hướng tăng rõ ràng:** Giá giao dịch phía trên các đường EMA (ví dụ: EMA9 > EMA21).
        2.  **Sóng điều chỉnh:** Giá giảm nhẹ và tiệm cận về các vùng hỗ trợ động như đường EMA 21.
        3.  **Điểm vào lệnh:** Khi giá chạm vào vùng hỗ trợ và có dấu hiệu đảo chiều (ví dụ: nến rút chân, RSI bật lên từ vùng 40-50).

*   **2. Chiến lược Giao dịch Phá vỡ (Breakout Trading):**
    *   **Mô tả:** Tìm kiếm cơ hội vào lệnh khi giá phá vỡ một mức kháng cự (để mua) hoặc hỗ trợ (để bán) quan trọng.
    *   **Cách xác định:**
        1.  **Vùng giá tích lũy:** Giá di chuyển trong một phạm vi hẹp (đi ngang) trong một thời gian.
        2.  **Phá vỡ:** Giá đóng cửa một cách dứt khoát phía trên vùng kháng cự hoặc phía dưới vùng hỗ trợ.
        3.  **Xác nhận:** Sự phá vỡ thường được xác nhận bởi khối lượng giao dịch (Volume) tăng đột biến.

*   **3. Chiến lược Giao dịch theo Xu hướng (Trend Following):**
    *   **Mô tả:** Đi theo xu hướng chính của thị trường.
    *   **Cách xác định:**
        1.  **Giao cắt EMA (EMA Cross):** Trong xu hướng tăng, đường EMA ngắn hạn (EMA9) cắt lên trên đường EMA dài hạn (EMA21). Ngược lại cho xu hướng giảm.
        2.  **Xác nhận xu hướng:** Giá liên tục tạo các đỉnh cao hơn và đáy cao hơn (xu hướng tăng) hoặc đỉnh thấp hơn và đáy thấp hơn (xu hướng giảm).

---

**QUY TRÌNH PHÂN TÍCH CHUYÊN SÂU:**

**Bước 1: Phân tích bối cảnh thị trường (Market Context)**
1.  **Xu hướng chính (Primary Trend):** Dựa vào vị trí của giá so với các đường EMA, xác định xu hướng dài hạn hơn trên khung thời gian này (Tăng giá, Giảm giá, Đi ngang).
2.  **Xu hướng phụ (Secondary Trend):** Phân tích các tín hiệu gần đây từ RSI và MACD để xác định động thái giá ngắn hạn.

**Bước 2: Phân tích hợp lưu các chỉ báo (Confluence Analysis)**
Tạo ra một danh sách các tín hiệu giao dịch chi tiết. Mỗi tín hiệu phải có "indicator" (RSI, MACD, EMA, Volume), "signal" (Mua, Bán, Trung tính), "confidence" (Cao, Trung bình, Thấp) và "reasoning" bằng tiếng Việt.
1.  **RSI (Relative Strength Index):**
    - Tín hiệu: Tài sản đang quá mua (>70), quá bán (<30) hay trung tính? Có tín hiệu phân kỳ không? Trong một xu hướng tăng, RSI được hỗ trợ trên mức 40 là một dấu hiệu tốt.
    - Độ tin cậy: Tín hiệu mạnh hơn khi ở các vùng cực trị và khi có sự xác nhận từ khối lượng.
2.  **MACD (Moving Average Convergence Divergence):**
    - Tín hiệu: Có sự giao cắt (bullish/bearish cross) không? Histogram đang dương hay âm và có đang mạnh lên hay yếu đi không?
    - Độ tin cậy: Tín hiệu mạnh hơn khi có sự giao cắt rõ ràng và histogram đồng thuận với xu hướng.
3.  **EMA (Exponential Moving Averages):**
    - Tín hiệu: Giá đang nằm trên hay dưới các đường EMA? Các đường EMA có đang dốc lên không? Chúng có đang hoạt động như các mức hỗ trợ/kháng cự động không? Có tín hiệu giao cắt EMA không?
    - Độ tin cậy: Cao khi giá tôn trọng các đường EMA.
4.  **Volume (Khối lượng giao dịch):**
    - Tín hiệu: Khối lượng giao dịch có đang tăng đột biến không? Nó đang xác nhận cho xu hướng hiện tại hay báo hiệu sự suy yếu? (ví dụ: giá tăng nhưng volume giảm là tín hiệu xấu; giá điều chỉnh với volume thấp là tín hiệu tốt cho phe mua).
    - Độ tin cậy: Cao khi có sự đột biến về khối lượng tại các vùng giá quan trọng.

**Bước 3: Tổng hợp và đưa ra kết luận (Synthesis & Conclusion)**
1.  **Đánh giá tổng quan:** Tổng hợp tất cả các phân tích trên và cả **tâm lý tin tức** để đưa ra một nhận định chung về thị trường (Tăng giá mạnh, Tăng giá yếu, Giảm giá mạnh, Giảm giá yếu, Đi ngang). **QUAN TRỌNG:** Một tín hiệu kỹ thuật 'MUA' phải được cân nhắc kỹ lưỡng và có thể bị giảm độ tin cậy nếu 'newsSentiment' là 'Negative'. Ngược lại, tín hiệu 'MUA' sẽ được củng cố nếu 'newsSentiment' là 'Positive'.
2.  **Giải thích logic:** Giải thích ngắn gọn cách các tín hiệu từ Bước 2 và tâm lý tin tức hỗ trợ cho đánh giá tổng quan của bạn. Cái nào là tín hiệu mạnh nhất? Có tín hiệu nào trái chiều không?
3.  **Tín hiệu giao dịch cuối cùng:** Dựa trên tất cả phân tích, đưa ra một tín hiệu cuối cùng: **MUA**, **BÁN**, hoặc **CHỜ ĐỢI**.

**Bước 4: Xây dựng kế hoạch giao dịch (Actionable Trading Plan)**
1.  **Chiến lược vào lệnh:** Đề xuất một chiến lược cụ thể dựa trên các chiến lược đã nêu ở trên. **QUAN TRỌNG:** Phải nêu rõ tên chiến lược đang áp dụng (ví dụ: "Áp dụng Chiến lược Mua theo Sóng Điều Chỉnh..."). Ví dụ: "Chờ giá điều chỉnh về vùng EMA 21 quanh [giá] rồi vào lệnh" hoặc "Mua khi giá phá vỡ và đóng cửa trên ngưỡng kháng cự [giá] với khối lượng lớn".
2.  **Vùng giá vào lệnh (Entry Zone):** Cung cấp một khoảng giá hợp lý để thực hiện chiến lược trên.
3.  **Dừng lỗ (Stop-loss):** Đề xuất mức dừng lỗ cụ thể. Mức này phải được đặt dựa trên một cơ sở kỹ thuật (ví dụ: dưới mức đáy gần nhất, dưới đường EMA quan trọng).
4.  **Chốt lời (Take-profit):** Đề xuất 1-2 mức chốt lời tiềm năng, dựa trên các mức kháng cự/hỗ trợ hoặc các mục tiêu giá hợp lý.

**Bước 5: Quản lý rủi ro (Risk Management)**
Cung cấp một lời khuyên ngắn gọn, súc tích và QUAN TRỌNG NHẤT về quản lý rủi ro cho giao dịch này.

**Yêu cầu:** Trả về kết quả bằng tiếng Việt, tuân thủ nghiêm ngặt định dạng JSON đầu ra, và thể hiện sự chuyên sâu trong phân tích.`,
  });

  const { output } = await analyzeCryptoPairPrompt(input);

  if (!output) {
    throw new Error("Phân tích AI không trả về kết quả.");
  }
  return output;
}
