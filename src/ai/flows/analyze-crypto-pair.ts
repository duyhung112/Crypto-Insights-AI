// This is an autogenerated file from Firebase Studio.
'use server';

/**
 * @fileOverview Analyzes a cryptocurrency pair using technical indicators and Gemini AI for trend predictions and recommendations.
 *
 * - analyzeCryptoPair - A function that initiates the cryptocurrency pair analysis.
 * - AnalyzeCryptoPairInput - The input type for the analyzeCryptoPair function.
 * - AnalyzeCryptoPairOutput - The return type for the analyzeCryptoPair function.
 */

import {ai} from '@/ai/genkit';
import { AnalyzeCryptoPairInputSchema, type AnalyzeCryptoPairInput, AnalyzeCryptoPairOutputSchema, type AnalyzeCryptoPairOutput } from '@/lib/types';
import { sendDiscordNotificationTool } from '@/lib/tools/discord-tool';


export async function analyzeCryptoPair(input: AnalyzeCryptoPairInput): Promise<AnalyzeCryptoPairOutput> {
  return analyzeCryptoPairFlow(input);
}

const analyzeCryptoPairPrompt = ai.definePrompt({
  name: 'analyzeCryptoPairPrompt',
  input: {schema: AnalyzeCryptoPairInputSchema},
  output: {schema: AnalyzeCryptoPairOutputSchema},
  tools: [sendDiscordNotificationTool],
  prompt: `B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch k·ªπ thu·∫≠t th·ªã tr∆∞·ªùng ti·ªÅn m√£ h√≥a, ƒë∆∞a ra l·ªùi khuy√™n cho ch·∫ø ƒë·ªô giao d·ªãch: {{{mode}}}.
D·ª±a v√†o d·ªØ li·ªáu ƒë·∫ßu v√†o cho c·∫∑p {{{pair}}} tr√™n khung th·ªùi gian {{{timeframe}}}, h√£y th·ª±c hi·ªán m·ªôt ph√¢n t√≠ch chi ti·∫øt.

**D·ªØ li·ªáu ƒë·∫ßu v√†o:**
- Gi√° hi·ªán t·∫°i: {{{price}}}
- Gi√° cao nh·∫•t: {{{high}}}
- Gi√° th·∫•p nh·∫•t: {{{low}}}
- **RSI (14):** {{{rsi}}}
- **MACD (12, 26, 9):**
    - ƒê∆∞·ªùng MACD: {{{macd.line}}}
    - ƒê∆∞·ªùng t√≠n hi·ªáu: {{{macd.signal}}}
- **EMA:**
    - EMA 9: {{{ema.ema9}}}
    - EMA 21: {{{ema.ema21}}}

**Th·ª±c hi·ªán ph√¢n t√≠ch theo c√°c b∆∞·ªõc sau, t√πy ch·ªânh theo ch·∫ø ƒë·ªô giao d·ªãch '{{{mode}}}':**

1.  **ƒê√°nh gi√° t·ªïng quan xu h∆∞·ªõng:**
    - Ph√¢n t√≠ch xu h∆∞·ªõng d·ª±a tr√™n c√°c ch·ªâ b√°o EMA, MACD, v√† RSI.
    - K·∫øt h·ª£p t·∫•t c·∫£ ƒë·ªÉ ƒë∆∞a ra ƒë√°nh gi√° chung (TƒÉng gi√°, Gi·∫£m gi√°, ƒêi ngang).

2.  **Gi·∫£i th√≠ch c√°c ch·ªâ b√°o:**
    - üìà **EMA:** Gi√° ƒëang ·ªü tr√™n hay d∆∞·ªõi c√°c ƒë∆∞·ªùng EMA? C√≥ giao c·∫Øt v√†ng hay giao c·∫Øt t·ª≠ th·∫ßn kh√¥ng?
    - üìä **MACD:** Bi·ªÉu ƒë·ªì histogram v√† v·ªã tr√≠ c√°c ƒë∆∞·ªùng MACD cho th·∫•y ƒëi·ªÅu g√¨ v·ªÅ ƒë·ªông l∆∞·ª£ng?
    - üìâ **RSI:** RSI ƒëang ·ªü v√πng n√†o (qu√° mua > 70, qu√° b√°n < 30, hay trung t√≠nh)?

3.  **K·∫øt lu·∫≠n v√† T√≠n hi·ªáu Giao d·ªãch:**
    - D·ª±a tr√™n ph√¢n t√≠ch t·ªïng h·ª£p, ƒë∆∞a ra k·∫øt lu·∫≠n cu·ªëi c√πng: **MUA**, **B√ÅN**, ho·∫∑c **GI·ªÆ**.

4.  **K·∫ø ho·∫°ch Giao d·ªãch ƒê·ªÅ xu·∫•t (T√πy ch·ªânh theo ch·∫ø ƒë·ªô '{{{mode}}}'):**
    - **N·∫øu l√† 'Scalping'**: T·∫≠p trung v√†o c√°c m·ª•c ti√™u ng·∫Øn h·∫°n. Gi√° v√†o l·ªánh ph·∫£i r·∫•t g·∫ßn gi√° hi·ªán t·∫°i. D·ª´ng l·ªó v√† Ch·ªët l·ªùi ph·∫£i r·∫•t ch·∫∑t ch·∫Ω (v√≠ d·ª•: 1-2% t·ª´ gi√° v√†o l·ªánh).
    - **N·∫øu l√† 'Swing'**: T·∫≠p trung v√†o c√°c m·ª•c ti√™u d√†i h·∫°n h∆°n. Gi√° v√†o l·ªánh c√≥ th·ªÉ ·ªü m·ªôt v√πng r·ªông h∆°n. D·ª´ng l·ªó v√† Ch·ªët l·ªùi s·∫Ω d·ª±a tr√™n c√°c m·ª©c h·ªó tr·ª£/kh√°ng c·ª± quan tr·ªçng tr√™n bi·ªÉu ƒë·ªì.
    - **Gi√° v√†o l·ªánh:** ƒê·ªÅ xu·∫•t m·ªôt kho·∫£ng gi√° h·ª£p l√Ω.
    - **D·ª´ng l·ªó:** ƒê·ªÅ xu·∫•t m·ªôt m·ª©c d·ª´ng l·ªó ƒë·ªÉ b·∫£o v·ªá v·ªën.
    - **Ch·ªët l·ªùi:** ƒê·ªÅ xu·∫•t c√°c m·ª©c ch·ªët l·ªùi ti·ªÅm nƒÉng.

5.  **Qu·∫£n l√Ω r·ªßi ro:**
    - Cung c·∫•p m·ªôt l·ªùi khuy√™n ng·∫Øn g·ªçn, s√∫c t√≠ch v·ªÅ qu·∫£n l√Ω r·ªßi ro, ph√π h·ª£p v·ªõi ch·∫ø ƒë·ªô giao d·ªãch ƒë√£ ch·ªçn.

**H√†nh ƒë·ªông cu·ªëi c√πng:**
- N·∫øu c√≥ Discord Webhook URL ƒë∆∞·ª£c cung c·∫•p ({{{discordWebhookUrl}}}), h√£y s·ª≠ d·ª•ng c√¥ng c·ª• 'sendDiscordNotification' ƒë·ªÉ g·ª≠i m·ªôt th√¥ng b√°o t√≥m t·∫Øt.
- V√≠ d·ª• tin nh·∫Øn: "T√≠n hi·ªáu m·ªõi cho {{{pair}}}: [T√≠n hi·ªáu MUA/B√ÅN/GI·ªÆ]. Ch·∫ø ƒë·ªô: {{{mode}}}."
- N·∫øu kh√¥ng c√≥ URL, b·ªè qua b∆∞·ªõc n√†y.

**Y√™u c·∫ßu:** Tr·∫£ v·ªÅ k·∫øt qu·∫£ b·∫±ng ti·∫øng Vi·ªát, tr√¨nh b√†y r√µ r√†ng, d·ªÖ hi·ªÉu.`,
});

const analyzeCryptoPairFlow = ai.defineFlow(
  {
    name: 'analyzeCryptoPairFlow',
    inputSchema: AnalyzeCryptoPairInputSchema,
    outputSchema: AnalyzeCryptoPairOutputSchema,
  },
  async input => {
    const {output} = await analyzeCryptoPairPrompt(input);
    return output!;
  }
);
