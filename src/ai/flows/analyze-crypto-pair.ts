
// This is an autogenerated file from Firebase Studio.
'use server';

/**
 * @fileOverview Analyzes a cryptocurrency pair using technical indicators and Gemini AI for trend predictions and recommendations.
 *
 * - analyzeCryptoPair - A function that initiates the cryptocurrency pair analysis.
 * - AnalyzeCryptoPairInput - The input type for the analyzeCryptoPair function.
 * - AnalyzeCryptoPairOutput - The return type for the analyzeCryptoPair function.
 */

import type { Genkit } from 'genkit';
import { AnalyzeCryptoPairInputSchema, type AnalyzeCryptoPairInput, AnalyzeCryptoPairOutputSchema, type AnalyzeCryptoPairOutput } from '@/lib/types';


export async function analyzeCryptoPair(input: AnalyzeCryptoPairInput, dynamicAi: Genkit): Promise<AnalyzeCryptoPairOutput> {

  const analyzeCryptoPairPrompt = dynamicAi.definePrompt({
    name: 'analyzeCryptoPairPrompt',
    input: {schema: AnalyzeCryptoPairInputSchema},
    output: {schema: AnalyzeCryptoPairOutputSchema},
    prompt: `Bạn là một nhà phân tích kỹ thuật và giao dịch tiền mã hóa chuyên nghiệp. Nhiệm vụ của bạn là thực hiện một phân tích đa khung thời gian (Multi-Timeframe Analysis - MTA) toàn diện, chuyên sâu và khách quan cho cặp {{{pair}}}.

**BỐI CẢNH PHÂN TÍCH:**
- **Chế độ giao dịch:** '{{{mode}}}' (Swing trading ưu tiên xu hướng dài hạn, Scalping ưu tiên động lượng ngắn hạn)
- **Khung thời gian chính (để vào lệnh):** {{{timeframe}}}
{{#if higherTimeframeData}}
- **Khung thời gian phụ (để xác định xu hướng lớn):** {{{higherTimeframeData.timeframe}}}
{{/if}}

---
**Dữ liệu đầu vào (Khung thời gian chính - {{{timeframe}}}):**
- Giá hiện tại: {{{price}}}
- RSI (14): {{{rsi}}}
- MACD (12, 26, 9):
    - Đường MACD: {{{macd.line}}}
    - Đường tín hiệu: {{{macd.signal}}}
- EMA:
    - EMA 9: {{{ema.ema9}}}
    - EMA 21: {{{ema.ema21}}}
- Khối lượng giao dịch (Volume) nến gần nhất: {{{volume}}}
- **Tâm lý tin tức gần đây: {{{newsSentiment}}} (Positive/Negative/Neutral)**

{{#if higherTimeframeData}}
**Dữ liệu đầu vào (Khung thời gian phụ - {{{higherTimeframeData.timeframe}}}):**
- Giá: {{{higherTimeframeData.price}}}
- RSI (14): {{{higherTimeframeData.rsi}}}
- MACD (12, 26, 9):
    - Đường MACD: {{{higherTimeframeData.macd.line}}}
    - Đường tín hiệu: {{{higherTimeframeData.macd.signal}}}
- EMA:
    - EMA 9: {{{higherTimeframeData.ema.ema9}}}
    - EMA 21: {{{higherTimeframeData.ema.ema21}}}
{{/if}}

---

**CÁC KHÁI NIỆM VÀ CHIẾN LƯỢC GIAO DỊCH CẦN ÁP DỤNG:**

*   **1. Chiến lược Giao dịch Mua theo Sóng Điều Chỉnh (Pullback Entry):**
    *   **Mô tả:** Trong một xu hướng tăng đang diễn ra, tìm kiếm cơ hội mua khi giá "điều chỉnh" (pullback) về một vùng hỗ trợ động quan trọng.
    *   **Cách xác định:**
        1.  **Xu hướng tăng rõ ràng:** Giá giao dịch phía trên các đường EMA (ví dụ: EMA9 > EMA21).
        2.  **Sóng điều chỉnh:** Giá giảm nhẹ và tiệm cận về các vùng hỗ trợ động như đường EMA 21.
        3.  **Điểm vào lệnh:** Khi giá chạm vào vùng hỗ trợ và có dấu hiệu đảo chiều (ví dụ: nến rút chân, RSI bật lên từ vùng 40-50).

*   **2. Chiến lược Giao dịch Phá vỡ (Breakout Trading):**
    *   **Mô tả:** Tìm kiếm cơ hội vào lệnh khi giá phá vỡ một mức kháng cự (để mua) hoặc hỗ trợ (để bán) quan trọng.
    *   **Cách xác định:**
        1.  **Vùng giá tích lũy:** Giá di chuyển trong một phạm vi hẹp (đi ngang) trong một thời gian.
        2.  **Phá vỡ:** Giá đóng cửa một cách dứt khoát phía trên vùng kháng cự (tín hiệu MUA) hoặc phía dưới vùng hỗ trợ (tín hiệu BÁN).
        3.  **Xác nhận:** Sự phá vỡ thường được xác nhận bởi khối lượng giao dịch (Volume) tăng đột biến.

*   **3. Chiến lược Giao dịch theo Xu hướng (Trend Following):**
    *   **Mô tả:** Đi theo xu hướng chính của thị trường, dù là tăng hay giảm.
    *   **Cách xác định:**
        1.  **Giao cắt EMA (EMA Cross):** Trong xu hướng tăng, đường EMA ngắn hạn (EMA9) cắt lên trên đường EMA dài hạn (EMA21). Ngược lại, trong xu hướng giảm, đường EMA9 cắt xuống dưới đường EMA21.
        2.  **Xác nhận xu hướng:** Giá liên tục tạo các đỉnh cao hơn và đáy cao hơn (xu hướng tăng) hoặc đỉnh thấp hơn và đáy thấp hơn (xu hướng giảm).

---

**QUY TRÌNH PHÂN TÍCH CHUYÊN SÂU (MTA):**

**Bước 1: Phân tích bối cảnh thị trường (Market Context & Primary Trend)**
{{#if higherTimeframeData}}
1.  **QUAN TRỌNG NHẤT: Xác định Xu hướng Chính trên Khung Thời gian Lớn ({{{higherTimeframeData.timeframe}}}):** Dựa vào vị trí của giá so với các đường EMA và cấu trúc đỉnh/đáy trên khung thời gian LỚN, hãy xác định xu hướng dài hạn (Tăng giá, Giảm giá, Đi ngang). Đây là yếu tố quan trọng nhất để ra quyết định. Một tín hiệu MUA trên khung thời gian nhỏ sẽ đáng tin cậy hơn rất nhiều nếu xu hướng trên khung thời gian lớn là TĂNG.
2.  **Xác định Xu hướng Phụ trên Khung Thời gian Chính ({{{timeframe}}}):** Phân tích các tín hiệu gần đây từ RSI và MACD trên khung thời gian chính để xác định động thái giá ngắn hạn.
{{else}}
1.  **Xác định Xu hướng Chính (Primary Trend):** Dựa vào vị trí của giá so với các đường EMA và cấu trúc đỉnh/đáy, xác định xu hướng chính trên khung thời gian này (Tăng giá, Giảm giá, Đi ngang).
2.  **Xác định Xu hướng Phụ (Secondary Trend):** Phân tích các tín hiệu gần đây từ RSI và MACD để xác định động thái giá ngắn hạn.
{{/if}}

**Bước 2: Phân tích hợp lưu các chỉ báo trên Khung Thời gian Chính ({{{timeframe}}})**
Tạo ra một danh sách các tín hiệu giao dịch chi tiết và khách quan. Mỗi tín hiệu phải có "indicator" (RSI, MACD, EMA, Volume), "signal" (Mua, Bán, Trung tính), "confidence" (một con số từ 0 đến 100 đại diện cho phần trăm độ tin cậy) và "reasoning" bằng tiếng Việt.
1.  **RSI (Relative Strength Index):**
    - Tín hiệu: Tài sản đang quá mua (>70 - tín hiệu tiềm năng BÁN), quá bán (<30 - tín hiệu tiềm năng MUA) hay trung tính? Có tín hiệu phân kỳ không?
    - Độ tin cậy: Tín hiệu mạnh hơn khi ở các vùng cực trị và khi có sự xác nhận từ các chỉ báo khác.
2.  **MACD (Moving Average Convergence Divergence):**
    - Tín hiệu: Có sự giao cắt (bullish/bearish cross) không? Giao cắt lên là tín hiệu MUA, giao cắt xuống là tín hiệu BÁN. Histogram đang dương hay âm và có đang mạnh lên hay yếu đi không?
    - Độ tin cậy: Tín hiệu mạnh hơn khi có sự giao cắt rõ ràng và histogram đồng thuận với xu hướng.
3.  **EMA (Exponential Moving Averages):**
    - Tín hiệu: Giá đang nằm trên (tín hiệu MUA) hay dưới (tín hiệu BÁN) các đường EMA? Các đường EMA có đang hoạt động như các mức hỗ trợ/kháng cự động không? Có tín hiệu giao cắt EMA không?
    - Độ tin cậy: Cao khi giá tôn trọng các đường EMA.
4.  **Volume (Khối lượng giao dịch):**
    - Tín hiệu: Khối lượng giao dịch có đang tăng đột biến không? Nó đang xác nhận cho xu hướng hiện tại hay báo hiệu sự suy yếu? (ví dụ: giá tăng mạnh với volume lớn xác nhận phe MUA; giá giảm mạnh với volume lớn xác nhận phe BÁN).
    - Độ tin cậy: Cao khi có sự đột biến về khối lượng tại các vùng giá quan trọng.

**Bước 3: Tổng hợp và đưa ra kết luận (Synthesis & Conclusion)**
1.  **Đánh giá tổng quan:** Tổng hợp tất cả các phân tích trên, **kết hợp xu hướng chính từ khung thời gian lớn**, các tín hiệu từ khung thời gian nhỏ và **tâm lý tin tức** để đưa ra một nhận định chung về thị trường (Tăng giá mạnh, Giảm giá mạnh, Đi ngang, etc.). **QUAN TRỌNG:** Một tín hiệu kỹ thuật 'MUA' phải được cân nhắc kỹ lưỡng nếu xu hướng chính đang GIẢM hoặc 'newsSentiment' là 'Negative'. Ngược lại, tín hiệu 'BÁN' được củng cố nếu xu hướng chính đang GIẢM và 'newsSentiment' là 'Negative'.
2.  **Giải thích logic:** Giải thích ngắn gọn cách các tín hiệu từ Bước 2 và tâm lý tin tức hỗ trợ cho đánh giá tổng quan của bạn. Có tín hiệu nào mạnh nhất? Có tín hiệu nào trái chiều không?
3.  **Tín hiệu giao dịch cuối cùng:** Dựa trên tất cả phân tích, đưa ra một tín hiệu cuối cùng một cách khách quan: **MUA**, **BÁN**, hoặc **CHỜ ĐỢI**.
4.  **Độ tin cậy tổng thể (Overall Confidence):** Dựa trên sự hợp lưu và độ tin cậy của các tín hiệu từ Bước 2, hãy tính toán và đưa ra một điểm **overallConfidence** (từ 0-100) cho tín hiệu giao dịch cuối cùng của bạn.

**Bước 4: Xây dựng kế hoạch giao dịch (Actionable Trading Plan)**
1.  **Chiến lược vào lệnh:** Đề xuất một chiến lược cụ thể dựa trên các chiến lược đã nêu ở trên. **QUAN TRỌNG:** Phải nêu rõ tên chiến lược đang áp dụng trong trường \`strategy\`.
2.  **Giá vào lệnh (Entry Price):** Cung cấp MỘT con số cụ thể làm giá vào lệnh. Ví dụ: 68500.5.
3.  **Dừng lỗ (Stop-loss):** Đề xuất MỘT con số cụ thể làm mức dừng lỗ. Mức này phải được đặt dựa trên một cơ sở kỹ thuật (ví dụ: dưới mức đáy gần nhất cho lệnh MUA, trên đỉnh gần nhất cho lệnh BÁN).
4.  **Chốt lời (Take-profit):** Đề xuất MỘT con số cụ thể làm mức chốt lời.

**Bước 5: Quản lý rủi ro (Risk Management)**
Cung cấp một lời khuyên ngắn gọn, súc tích và QUAN TRỌNG NHẤT về quản lý rủi ro cho giao dịch này.

**Yêu cầu:** Trả về kết quả bằng tiếng Việt, tuân thủ nghiêm ngặt định dạng JSON đầu ra, và thể hiện sự chuyên sâu, khách quan trong phân tích.`,
  });

  const { output } = await analyzeCryptoPairPrompt(input);

  if (!output) {
    throw new Error("Phân tích AI không trả về kết quả.");
  }
  return output;
}
