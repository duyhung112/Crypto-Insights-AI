// This is an autogenerated file from Firebase Studio.
'use server';

/**
 * @fileOverview Analyzes a cryptocurrency pair using technical indicators and Gemini AI for trend predictions and recommendations.
 *
 * - analyzeCryptoPair - A function that initiates the cryptocurrency pair analysis.
 * - AnalyzeCryptoPairInput - The input type for the analyzeCryptoPair function.
 * - AnalyzeCryptoPairOutput - The return type for the analyzeCryptoPair function.
 */

import {ai} from '@/ai/genkit';
import { AnalyzeCryptoPairInputSchema, type AnalyzeCryptoPairInput, AnalyzeCryptoPairOutputSchema, type AnalyzeCryptoPairOutput } from '@/lib/types';


export async function analyzeCryptoPair(input: AnalyzeCryptoPairInput): Promise<AnalyzeCryptoPairOutput> {
  return analyzeCryptoPairFlow(input);
}

const analyzeCryptoPairPrompt = ai.definePrompt({
  name: 'analyzeCryptoPairPrompt',
  input: {schema: AnalyzeCryptoPairInputSchema},
  output: {schema: AnalyzeCryptoPairOutputSchema},
  prompt: `You are an expert cryptocurrency technical analyst. Based on the provided data for the {{{pair}}} pair on the {{{timeframe}}} timeframe, perform a detailed analysis.

**Input Data:**
- Current Price: {{{price}}}
- High Price: {{{high}}}
- Low Price: {{{low}}}
- **RSI (14):** {{{rsi}}}
- **MACD (12, 26, 9):**
    - MACD Line: {{{macd.line}}}
    - Signal Line: {{{macd.signal}}}
- **EMA:**
    - EMA 9: {{{ema.ema9}}}
    - EMA 21: {{{ema.ema21}}}

**Perform the analysis in the following steps:**

1.  **Overall Trend Assessment:**
    - Trend based on the price's position relative to the EMA 9 and EMA 21.
    - Trend based on the crossover of the two EMA lines.
    - Trend based on the MACD (position relative to the zero line, crossover between the MACD and signal lines).
    - Strength of the trend based on the RSI.
    - Combine all to give a general assessment (Bullish, Bearish, Sideways).

2.  **Indicator Explanations:**
    - ðŸ“ˆ **EMA:** Is the price above or below the EMA lines? Is there a golden cross (short EMA crosses above long EMA) or a death cross (short EMA crosses below long EMA)?
    - ðŸ“Š **MACD:** Is the histogram positive or negative? Is the MACD line crossing above or below the signal line? Is this signal strong or weak?
    - ðŸ“‰ **RSI:** Which zone is the RSI in (overbought > 70, oversold < 30, or neutral)? Is it trending up or down?

3.  **Conclusion and Trading Signal:**
    - Based on the combined analysis, provide a final conclusion: **BUY**, **SELL**, or **HOLD**.

4.  **Proposed Trading Plan:**
    - **Entry Price:** Suggest a reasonable price range for entry.
    - **Stop-loss:** Suggest a stop-loss level to protect capital, typically below a recent support level (for a Buy order) or above a recent resistance level (for a Sell order).
    - **Take-profit:** Suggest potential take-profit levels, typically the next resistance levels (for a Buy order) or support levels (for a Sell order).

5.  **Risk Management:**
    - Provide a short, concise piece of advice on risk management for this trade.

**Requirement:** Return the result in English, presented clearly and easy to understand. Use bullet points or emojis to highlight the main points.`,
});

const analyzeCryptoPairFlow = ai.defineFlow(
  {
    name: 'analyzeCryptoPairFlow',
    inputSchema: AnalyzeCryptoPairInputSchema,
    outputSchema: AnalyzeCryptoPairOutputSchema,
  },
  async input => {
    const {output} = await analyzeCryptoPairPrompt(input);
    return output!;
  }
);
